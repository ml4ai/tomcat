<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Working with .metadata files &mdash; ToMCAT 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Guide to developing ToMCAT missions" href="missions.html" />
    <link rel="prev" title="Working with the MQTT message bus" href="message_bus.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> ToMCAT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../software.html">Software Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../team.html">Team</a></li>
<li class="toctree-l1"><a class="reference internal" href="../become_a_participant.html">Become a participant</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Design and Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="message_bus.html">Working with the MQTT message bus</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Working with .metadata files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#json-key-reference-convention">JSON key reference convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="#metadata-file-contents-and-format"><code class="docutils literal notranslate"><span class="pre">.metadata</span></code> file contents and format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quick-exploration-with-jq">Quick exploration with <code class="docutils literal notranslate"><span class="pre">jq</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#offline-analyses-with-metadata-files">Offline analyses with .metadata files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#online-analyses-with-metadata-files">Online analyses with .metadata files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="missions.html">Guide to developing ToMCAT missions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Client_Server_Communication.html">Message Exchange between Client and Server in Minecraft Forge</a></li>
<li class="toctree-l2"><a class="reference internal" href="prebuilt_world_loading.html">Pre-Built World Loading Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="minecraft_forge_events.html">Events available through the Minecraft Forge event bus (for MC v1.11.2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploying_to_ta3_testbed.html">Steps for deploying a component to the TA3 testbed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpp_api/index.html">C++ API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tomcat_openapi.html">Data models and message bus topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../langlab/index.html">Lang Lab Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ToMCAT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Developer documentation</a> &raquo;</li>
      <li>Working with .metadata files</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developer/metadata_files.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="working-with-metadata-files">
<h1>Working with .metadata files<a class="headerlink" href="#working-with-metadata-files" title="Permalink to this heading"></a></h1>
<p><em>Author: Adarsh Pyarelal</em></p>
<div class="toctree-wrapper compound">
</div>
<p>In this writeup, we will describe the <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> files produced by the TA3
testbed and how to work with them.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> file contains all the messages that were published on the MQTT
message bus (if you are not familiar with the concept of a message bus, see
<a class="reference external" href="message_bus">here</a> for a brief introduction) during a particular trial.</p>
<section id="json-key-reference-convention">
<h2>JSON key reference convention<a class="headerlink" href="#json-key-reference-convention" title="Permalink to this heading"></a></h2>
<p>In the rest of this writeup, we use the following convention to refer to values
in JSON objects. Consider the following example JSON object:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="nt">&quot;key3&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2&quot;</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In the above, the value at <code class="docutils literal notranslate"><span class="pre">.key1</span></code> is <code class="docutils literal notranslate"><span class="pre">value1</span></code>. We extend this pattern for
nested objects, so the value at <code class="docutils literal notranslate"><span class="pre">.key2.key3</span></code> is <code class="docutils literal notranslate"><span class="pre">value2</span></code>.</p>
</section>
<section id="metadata-file-contents-and-format">
<h2><code class="docutils literal notranslate"><span class="pre">.metadata</span></code> file contents and format<a class="headerlink" href="#metadata-file-contents-and-format" title="Permalink to this heading"></a></h2>
<p>The first line of a <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> file contains metadata about the trial itself,
and is generated by the TA3-developed mechanism that exports the data from the
Elasticsearch database in which the messages are stored. This metadata is also
used by the TA3 application that can be used to import .metadata files into an
Elastic database. For now, ToMCAT team members can ignore this line.</p>
<p>The subsequent lines of the file are the messages published on the bus during a
trial. Each line of the file corresponds to a single message. The messages
themselves are in JSON format, with the following objects: <code class="docutils literal notranslate"><span class="pre">.header</span></code>,
<code class="docutils literal notranslate"><span class="pre">.msg</span></code>, and <code class="docutils literal notranslate"><span class="pre">.data</span></code>. We describe them and their subcomponents below.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">.header</span></code> : A common header for all messages on the testbed.
- <code class="docutils literal notranslate"><span class="pre">.header.timestamp</span></code>: Timestamp of when the message was published.
- <code class="docutils literal notranslate"><span class="pre">.header.message_type</span></code>: The type of message
- <code class="docutils literal notranslate"><span class="pre">.header.version</span></code>: A version number that tells downstream applications how to parse the <code class="docutils literal notranslate"><span class="pre">.msg</span></code> portion of the message.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.msg</span></code> : This component contains metadata about the experiment, trial, and the message itself.
- <code class="docutils literal notranslate"><span class="pre">.msg.experiment_id</span></code>: The experiment ID.
- <code class="docutils literal notranslate"><span class="pre">.msg.trial_id</span></code>: The trial ID.
- <code class="docutils literal notranslate"><span class="pre">.msg.timestamp</span></code>: Timestamp of when the message was generated (this is</p>
<blockquote>
<div><p>usually the same or almost the same as the <code class="docutils literal notranslate"><span class="pre">.header.timestamp</span></code>)</p>
</div></blockquote>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.msg.source</span></code>: The ID of the testbed component that published the
message.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.msg.sub_type</span></code>: The sub-type of the message (for components that publish
more than one type of message).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.msg.version</span></code>: A version number that tells downstream applications how
to parse the <code class="docutils literal notranslate"><span class="pre">.data</span></code> portion of the message.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">.data</span></code>: This component contains the actual data published by the testbed
component. The contents of this object depend on the functionality of the
testbed component in question.</p></li>
</ul>
<p>In addition to these objects, the export process for the
<code class="docutils literal notranslate"><span class="pre">.metadata</span></code> files adds two additional keys that were not part of the
original message:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.topic</span></code>: The topic that the message was originally published on.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.&#64;timestamp</span></code>: The timestamp marking when the message was ingested by the
Elastic stack.</p></li>
</ul>
</section>
<section id="quick-exploration-with-jq">
<h2>Quick exploration with <code class="docutils literal notranslate"><span class="pre">jq</span></code><a class="headerlink" href="#quick-exploration-with-jq" title="Permalink to this heading"></a></h2>
<p>For quick exploration of <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> files, you can use <a class="reference external" href="https://stedolan.github.io/jq/">jq</a>, which is kind of
like a JSON-aware <code class="docutils literal notranslate"><span class="pre">grep</span></code>. If you are working on the <code class="docutils literal notranslate"><span class="pre">kraken</span></code> compute VM,
<code class="docutils literal notranslate"><span class="pre">jq</span></code> is already installed on it. If not, you can install it using a package
manager (e.g., <code class="docutils literal notranslate"><span class="pre">apt</span></code>, MacPorts, etc.).</p>
<p>The output of <code class="docutils literal notranslate"><span class="pre">jq</span></code> can be piped into further invocations of <code class="docutils literal notranslate"><span class="pre">jq</span></code> or to
other command-line tools in order to compose pipelines.  Here are some
potentially useful <code class="docutils literal notranslate"><span class="pre">jq</span></code> recipes for working with <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> files.</p>
<p><strong>Pretty-printing</strong> Pretty-print all the messages in a <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> file on a particular topic:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>jq &#39;select(.topic==&quot;topic_name&quot;)&#39; &lt; input.metadata
</pre></div>
</div>
<p><strong>Selecting fields</strong>: Print all the <code class="docutils literal notranslate"><span class="pre">.header.timestamp</span></code> values for messages on a particular topic:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>jq &#39;select(.topic==&quot;topic_name&quot;)&#39; &lt; input.metadata | jq &#39;.header.timestamp&#39;
</pre></div>
</div>
<p><strong>Filtering</strong>: Create a new <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> file containing only the messages on a certain
topic (the <code class="docutils literal notranslate"><span class="pre">-c</span></code> flag below disables pretty-printing):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>jq -c &#39;select(.topic==&quot;topic_name&quot;)&#39; &lt; input.metadata &gt;  output.metadata
</pre></div>
</div>
<p><strong>Unix tool composition</strong>: Count the number of messages on a given topic:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>jq -c &#39;select(.topic==&quot;topic_name&quot;)&#39; &lt; input.metadata | wc -l
</pre></div>
</div>
</section>
<section id="offline-analyses-with-metadata-files">
<h2>Offline analyses with .metadata files<a class="headerlink" href="#offline-analyses-with-metadata-files" title="Permalink to this heading"></a></h2>
<p>While you can use <code class="docutils literal notranslate"><span class="pre">jq</span></code> for quick exploration at the command line, for more
detailed offline analysis you should write scripts in Python or programs in
C++. We use the term <em>offline</em> to refer to an analysis that does not require a
message broker to be running - that is, your programs operate directly on the
files themselves rather than consuming the messages from a message bus.</p>
</section>
<section id="online-analyses-with-metadata-files">
<h2>Online analyses with .metadata files<a class="headerlink" href="#online-analyses-with-metadata-files" title="Permalink to this heading"></a></h2>
<p>In contrast to offline analysis, you can also run <em>online</em> analyses with
<code class="docutils literal notranslate"><span class="pre">.metadata</span></code> files using a <em>replayer</em> program that reads in messages from a
<code class="docutils literal notranslate"><span class="pre">.metadata</span></code> files and re-publishes them to the message bus. The
<a class="reference external" href="https://github.com/ml4ai/tomcat/blob/master/tools/elkless_replayer">elkless_replayer</a> is an example of such a program. Replays are essential to
be able to develop and test testbed components that work with the message bus.</p>
<p>Here are some of my tips for working with the <code class="docutils literal notranslate"><span class="pre">elkless_replayer</span></code>.</p>
<ul>
<li><p>Clone the <code class="docutils literal notranslate"><span class="pre">ml4ai/tomcat</span></code> repo in order to be able to pull updates to the
replayer whenever necessary.</p></li>
<li><p>Add the path to the directory containing the script to your <code class="docutils literal notranslate"><span class="pre">PATH</span></code>
environment variable so that you can invoke it from any directory.</p></li>
<li><p>Create a virtual environment in which you can install
necessary Python packages (I have one named <code class="docutils literal notranslate"><span class="pre">tomcat</span></code> that I use for all my
<code class="docutils literal notranslate"><span class="pre">tomcat</span></code> Python programming tasks). For the <code class="docutils literal notranslate"><span class="pre">elkless_replayer</span></code> you can install the
prerequisites by running the following in your virtual environment:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">paho</span><span class="o">-</span><span class="n">mqtt</span><span class="w"> </span><span class="n">tqdm</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>To see the help message and the command line options, run:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">elkless_replayer</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>By default, the <code class="docutils literal notranslate"><span class="pre">elkless_replayer</span></code> replays messages in the order they are
in the <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> file. This should work for the majority of <code class="docutils literal notranslate"><span class="pre">.metadata</span></code>
files. However, for some files that have been run through the TA3 replay
process, the timestamps have been adjusted, and the correction process might
make the messages in the <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> file not sorted correctly by their
<code class="docutils literal notranslate"><span class="pre">&#64;timestamp</span></code> key. In this scenario (and perhaps in others if you wish), you
can have the replayer sort the messages by their <code class="docutils literal notranslate"><span class="pre">.header.timestamp</span></code> value
prior to publishing them.</p></li>
<li><p>The default behavior of the replayer is to publish messages as fast as
possible. This is good if your testbed component can handle it, or if you
want to do some quick testing without worrying too much about the timing
between messages. However, for a replay that is more faithful to
the original experimental trial, you can use The <code class="docutils literal notranslate"><span class="pre">-r</span></code> (for ‘real-time’)
flag, which tells the replayer to insert delays between publishing
messages that approximate the delays between messages in the original trial.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="message_bus.html" class="btn btn-neutral float-left" title="Working with the MQTT message bus" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="missions.html" class="btn btn-neutral float-right" title="Guide to developing ToMCAT missions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, University of Arizona.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>