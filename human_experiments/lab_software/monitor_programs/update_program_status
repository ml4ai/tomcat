#!/usr/bin/env bash

program_status=""

_update_minecraft_program_status() {
  local client_name=$1
  local log_file=$2
  local pid_file=$3

  if [[ -e "$pid_file" ]]; then
    started "$client_name"
    program_status=$global_stamp

    if [[ $(grep -c '\[ERROR\]' "$log_file") -ne 0 ]]; then
      error "$client_name"
      program_status=$global_stamp
      return
    fi

    if [[ $(grep -c '\[INFO\] Stopped' "$log_file") -ne 0 ]]; then
      not_started "$client_name"
      program_status=$global_stamp
      return
    fi

    if [[ $(grep -c '\[INFO\] Started' "$log_file") -ne 0 ]]; then
      # Successfully recording from the device.
      running "$client_name"
      program_status=$global_stamp
    fi

    if [[ $(grep -c '\[WARN\] LSL' "$log_file") -ne 0 ]]; then
      # Successfully recording from the device.
      running_no_lsl "$client_name"
      program_status=$global_stamp
    fi
  else
    not_started "$client_name"
    program_status=$global_stamp
  fi
}

# Webcam
_update_minecraft_program_status "Lion" "$EXPERIMENT_DIR/tmp/webcam_lion.log" "$EXPERIMENT_DIR/tmp/webcam_lion.pid"
LION_MC_PROG=$program_status

_update_minecraft_program_status "Tiger" "$EXPERIMENT_DIR/tmp/webcam_tiger.log" "$EXPERIMENT_DIR/tmp/webcam_tiger.pid"
TIGER_MC_PROG=$program_status

_update_minecraft_program_status "Leopard" "$EXPERIMENT_DIR/tmp/webcam_leopard.log" "$EXPERIMENT_DIR/tmp/webcam_leopard.pid"
LEOPARD_MC_PROG=$program_status

_update_minecraft_program_status "Tom" "$EXPERIMENT_DIR/tmp/webcam_leopard.log" "$EXPERIMENT_DIR/tmp/webcam_leopard.pid"
SERVER_MC_PROG=$program_status
