#!/bin/bash

set -u

TIME_DIFFERENCE_SESSION_NAME="time-difference"
TIME_DIFFERENCE_SERVER_NAME="time-difference-server"
TIME_DIFFERENCE_CLIENT_NAME="time-difference-client"
TIME_DIFFERENCE_FILE_NAME="$DATA_ROOT_DIR/time_difference.txt"

__launch_time_difference_tom_server() {
  local command="cd $HOME/$SYSTEMS_DIR/tomcat/human_experiments/lab_software/tomcat-time-difference; "
  command+="python3 run_server.py -f $TIME_DIFFERENCE_FILE_NAME"
  tmux new-session -d -s $TIME_DIFFERENCE_SESSION_NAME -n "$TIME_DIFFERENCE_SERVER_NAME" "$command"
}

__launch_time_difference_cat_client() {
  command+="python3 run_client.py"
  ssh -t cat@cat "tmux new-session -d -s $TIME_DIFFERENCE_SESSION_NAME -n $TIME_DIFFERENCE_CLIENT_NAME -n CAT"
}

__record_time_difference() {
  tmux send-keys -t "$TIME_DIFFERENCE_SESSION_NAME:$TIME_DIFFERENCE_SERVER_NAME" "close" Enter
}

__report_time_difference() {
  cat "$TIME_DIFFERENCE_FILE_NAME"
}

__launch_time_difference_tom_server
sleep 1
__launch_time_difference_cat_client
sleep 1
__record_time_difference
sleep 1
__report_time_difference
