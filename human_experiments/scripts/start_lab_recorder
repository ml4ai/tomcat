#!/bin/bash

set -u

source wifi

USER_ON_TARGET="cat"
TARGET_IP="cat.local"

if [[ -z ${1+x} ]]; then
  PADDING=""
else
  PADDING=$1
fi

# We disable the WiFi in all of the clients to avoid issues with the fNIRS signals.
disable_wifi "lion" "lion.local" "$PADDING"
disable_wifi "tiger" "tiger.local" "$PADDING"
disable_wifi "leopard" "leopard.local" "$PADDING"

if [[ ${EXPERIMENT_DIR::1} != "/" ]]; then
  # In case the first character of experiment is not a slash '/'.
  text="\n${RED}First character of experiment directory must be a slash '/' !${NC}\n"
  text+="${YELLOW}Example: ./start_lab_recorder /data/cat/dry_runs/testing_2022_08_31_01\n"
  text+="(experiment directory must start with a slash '/' and not end with a slash.)${NC}\n"
  echo -e "$text"
  exit 1
fi

echo " "
echo -e "${YELLOW}WARNING: All prior instances of LabRecorder running on CAT will be killed!${NC}"
if ! yes_no_question "${YELLOW}DO YOU WANT TO CONTINUE?${NC}"; then
  echo " "
  echo -e "${RED}Starting LabRecorder - ABORTED!${NC}"
  echo " "
  exit 1
fi

# Set var to where the app LabRecorder path/app is located on CAT.
LAB_RECORDER_APP="/usr/LabRecorder/./LabRecorder"

# Set var to where the LabRecorder config directory is located on CAT.
CONFIG_DIR="\$HOME/$SYSTEMS_DIR/tomcat/human_experiments/config/LabRecorder_config"

# Set vars with Lion, Tiger and Leopard unique config path/file located on git.
LION_CONFIG_FILE="${CONFIG_DIR}/LabRecorder_Lion_22345.cfg"
TIGER_CONFIG_FILE="${CONFIG_DIR}/LabRecorder_Tiger_22346.cfg"
LEOPARD_CONFIG_FILE="${CONFIG_DIR}/LabRecorder_Leopard_22347.cfg"

# Set vars with Lion, Tiger and Leopard data (StorageLocation) path/file.
LION_STORAGE_LOCATION="${EXPERIMENT_DIR}/lion/eeg_fnirs_pupil/lion_eeg_fnirs_pupil.xdf"
TIGER_STORAGE_LOCATION="${EXPERIMENT_DIR}/tiger/eeg_fnirs_pupil/tiger_eeg_fnirs_pupil.xdf"
LEOPARD_STORAGE_LOCATION="${EXPERIMENT_DIR}/leopard/eeg_fnirs_pupil/leopard_eeg_fnirs_pupil.xdf"


echo " "
echo -e "Configuring LabRecorder's config files with data path/file:"
echo -e "${GREEN}Lion: ${LION_STORAGE_LOCATION}${NC}"
echo -e "${GREEN}Tiger: ${TIGER_STORAGE_LOCATION}${NC}"
echo -e "${GREEN}Leopard: ${LEOPARD_STORAGE_LOCATION}${NC}"

# Change (string find and replace) "StorageLocation=" line in Lion, Tiger and Leopards
# unique configuration files to have the Storage Location of the xdf file
# specified in this experiment.
ssh "$USER_ON_TARGET@$TARGET_IP" sed -i 's#StorageLocation=.*#StorageLocation='"$LION_STORAGE_LOCATION"'#' "$LION_CONFIG_FILE"
ssh "$USER_ON_TARGET@$TARGET_IP" sed -i 's#StorageLocation=.*#StorageLocation='"$TIGER_STORAGE_LOCATION"'#' "$TIGER_CONFIG_FILE"
ssh "$USER_ON_TARGET@$TARGET_IP" sed -i 's#StorageLocation=.*#StorageLocation='"$LEOPARD_STORAGE_LOCATION"'#' "$LEOPARD_CONFIG_FILE"

# Kill any prior instances of LabRecorder on CAT so that fresh instances can be opened.
ssh "$USER_ON_TARGET@$TARGET_IP" pkill LabRecorder

echo " "
echo -e "${YELLOW}Killed any prior instances of LabRecorder running on CAT!${NC}"


# Will need to open 3 fresh instances of LabRecorder to guarantee they using
# correct config file, connecting to correct streams and using Experiment Dir
# and Data File for this Experiment.
echo " "
echo -e "Opening 3 instances of LabRecorder on CAT:"
# shellcheck disable=SC2029
ssh "$USER_ON_TARGET@$TARGET_IP" "DISPLAY=:1 ${LAB_RECORDER_APP} -c ${LION_CONFIG_FILE} &>/dev/null &"
# shellcheck disable=SC2029
ssh "$USER_ON_TARGET@$TARGET_IP" "DISPLAY=:1 ${LAB_RECORDER_APP} -c ${TIGER_CONFIG_FILE} &>/dev/null &"
# shellcheck disable=SC2029
ssh "$USER_ON_TARGET@$TARGET_IP" "DISPLAY=:1 ${LAB_RECORDER_APP} -c ${LEOPARD_CONFIG_FILE} &>/dev/null &"
echo " "
ssh "$USER_ON_TARGET@$TARGET_IP" ps -F -C LabRecorder
echo " "

# After the 3 LabRecorder instances are open on CAT, restore the 3 modified LabRecorder config files
# back to what is on the main git repository using the "git checkout <file>" command.
# This is done so that git will not detect on any branch that the config files have been modified.
echo -e "Restoring the 3 LabRecorder config files back to what is in the main git repository on CAT:"
# shellcheck disable=SC2029
ssh "$USER_ON_TARGET@$TARGET_IP" "cd ${CONFIG_DIR} && git checkout LabRecorder_Lion_22345.cfg"
# shellcheck disable=SC2029
ssh "$USER_ON_TARGET@$TARGET_IP" "cd ${CONFIG_DIR} && git checkout LabRecorder_Tiger_22346.cfg"
# shellcheck disable=SC2029
ssh "$USER_ON_TARGET@$TARGET_IP" "cd ${CONFIG_DIR} && git checkout LabRecorder_Leopard_22347.cfg"
echo " "

echo -e "${YELLOW}Verify that you have 3 LabRecorder windows open on CAT and that they are all recording the correct streams!${NC}"
echo -e "${EMPH}(The 3 LabRecorder windows on CAT might be stacked on top of each other so, "
echo -e " you may have to use CAT's mouse to separate them!)${NC}"
echo " "
